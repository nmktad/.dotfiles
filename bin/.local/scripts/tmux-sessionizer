#!/usr/bin/env bash

explicit_dirs=(
  "$HOME/.dotfiles"
)

search_dirs=(
  "$HOME/workspaces/personal"
  "$HOME/workspaces/sandbox"
  "$HOME/workspaces/org/work"
  "$HOME/workspaces/org/zewdlabs/"
)

# Build the list: echo explicit dirs + find subdirs
project_dirs=$(
  {
    for d in "${explicit_dirs[@]}"; do
      echo "$d"
    done
    for d in "${search_dirs[@]}"; do
      find "$d" -mindepth 1 -maxdepth 1 -type d
    done
  } | fzf
)

# Handle selection
if [[ -z $1 && -n $project_dirs ]]; then
  selected=$project_dirs
elif [[ -n $1 ]]; then
  selected=$1
else
  exit 0
fi

selected_name=$(basename "$selected" | tr . _)

if [[ -z $TMUX ]] && [[ -z $(pgrep tmux) ]]; then
    tmux new-session -s "$selected_name" -c "$selected"
    exit 0
fi

if ! tmux has-session -t="$selected_name" 2> /dev/null; then
    tmux new-session -ds "$selected_name" -c "$selected"
fi

if [[ -z $TMUX ]]; then
    tmux attach-session -t "$selected_name"
else
    tmux switch-client -t "$selected_name"
fi
